# Living Twin Synthetic Data Generation - Project Makefile

.PHONY: all help clean install build demo dev stop test health \
	run-structured-data run-strategic-docs run-unified-personas run-quick-data list-scripts \
	show-outputs clean-outputs export-json export-training backup-data


# Default target
all: install build demo

help: ## Show this help message
	@echo "Living Twin Synthetic Data Generation"
	@echo "===================================="
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  %-15s %s\n", $$1, $$2}'

install: ## Install Python dependencies using uv
	@echo "ğŸ“¦ Installing dependencies for Living Twin Synthetic Data..."
	@pip install uv
	@uv sync
	@echo "âœ… Dependencies installed"

build: ## Build Docker image
	@echo "ğŸ—ï¸ Building Living Twin Synthetic Data Docker image..."
	@docker-compose build
	@echo "âœ… Docker image built"

demo: ## Start the demo server
	@echo "ğŸ­ Starting Living Twin Synthetic Data demo..."
	@echo "ğŸ“ Demo will be available at: http://localhost:8004"
	@docker-compose up -d
	@echo "âœ… Demo server started"
	@echo "ğŸ’¡ Use 'make logs' to view logs, 'make stop' to stop"

dev: demo ## Alias for demo (development mode)

stop: ## Stop all services
	@echo "ğŸ›‘ Stopping Living Twin Synthetic Data services..."
	@docker-compose down
	@echo "âœ… Services stopped"

clean: ## Clean temporary files and containers
	@echo "ğŸ§¹ Cleaning temporary files..."
	@docker-compose down -v --remove-orphans 2>/dev/null || true
	@docker system prune -f 2>/dev/null || true
	@rm -rf outputs/tmp/ outputs/cache/ || true
	@echo "âœ… Temporary files cleaned"

really-clean: ## Deep clean - remove all regenerable data
	@echo "ğŸ§¹ Deep clean - removing regenerable data..."
	@$(MAKE) clean
	@rm -rf generated/
	@rm -rf outputs/
	@rm -rf production_data/
	@echo "âœ… Deep clean complete - regenerable data removed"
	@echo "ğŸ“¦ Preserved: archives/, id_registry/, scripts/"
	@echo "ğŸ’¡ Tip: Restore with 'make restore-from-archive'"

logs: ## Show service logs
	@docker-compose logs -f

health: ## Check service health
	@echo "ğŸ¥ Checking Living Twin Synthetic Data health..."
	@curl -s http://localhost:8004/health || echo "Service not responding"

test: ## Run tests
	@echo "ğŸ§ª Running Living Twin Synthetic Data tests..."
	@uv run python -m pytest test_*.py -v || echo "No tests found"
	@echo "âœ… Tests complete"

# Development targets
run-local: install ## Run locally without Docker
	@echo "ğŸ”¬ Running Living Twin Synthetic Data locally..."
	@uv run uvicorn server.main:app --host 0.0.0.0 --port 8004 --reload

# Data generation targets
generate-orgs: ## Generate organizations only
	@echo "ğŸ¢ Generating organizations..."
	@curl -X POST http://localhost:8004/generate/organizations \
		-H "Content-Type: application/json" \
		-d '{"count": 10}' || echo "Service not running"

generate-people: ## Generate people personas
	@echo "ğŸ‘¥ Generating people..."
	@curl -X POST http://localhost:8004/generate/people \
		-H "Content-Type: application/json" \
		-d '{"organization_id": "sample_org", "count": 25}' || echo "Service not running"

generate-all: ## Run full generation pipeline
	@echo "ğŸš€ Running full generation pipeline..."
	@curl -X POST http://localhost:8004/pipeline/run \
		-H "Content-Type: application/json" || echo "Service not running"

# Environment setup
setup-env: ## Create .env file from template
	@if [ ! -f .env ]; then \
		echo "ğŸ”§ Creating .env file..."; \
		echo "OPENAI_API_KEY=your_openai_key_here" > .env; \
		echo "ELEVENLABS_API_KEY=your_elevenlabs_key_here" >> .env; \
		echo "AWS_REGION=us-east-1" >> .env; \
		echo "AWS_BEDROCK_ENABLED=false" >> .env; \
		echo "âœ… Created .env file - please update with your API keys"; \
	else \
		echo "ğŸ“‹ .env file already exists"; \
	fi

# Script execution targets
run-structured-data: install ## Generate structured organizational data
	@echo "ğŸ¢ Generating structured organizational data..."
	@uv run python scripts/generate_structured_data.py

run-strategic-docs: install ## Generate strategic business documents
	@echo "ğŸ“‹ Generating strategic documents..."
	@uv run python scripts/generate_strategic_documents.py

run-unified-personas: install ## Generate unified personas pipeline
	@echo "ğŸ‘¥ Running unified personas pipeline..."
	@uv run python scripts/unified_persona_pipeline.py

run-quick-data: install ## Generate quick sample data
	@echo "âš¡ Generating quick sample data..."
	@uv run python scripts/quick_structured_data.py

# List available scripts
list-scripts: ## Show available generation scripts
	@echo "ğŸ“œ Available generation scripts:"
	@echo "  make run-structured-data    - Generate structured organizational data"
	@echo "  make run-strategic-docs     - Generate strategic business documents"  
	@echo "  make run-unified-personas   - Generate unified personas pipeline"
	@echo "  make run-quick-data         - Generate quick sample data"
	@echo ""
	@echo "ğŸ“– For more details, see: scripts/README.md"

# Data management targets
show-outputs: ## Show generated data summary
	@echo "ğŸ“Š Generated Data Summary:"
	@echo "=========================="
	@echo "ğŸ“ Organizations: $$(find outputs/organizations -name "*.json" 2>/dev/null | wc -l | tr -d ' ') files"
	@echo "ğŸ‘¥ People: $$(find outputs/people -name "*.json" 2>/dev/null | wc -l | tr -d ' ') files"
	@echo "ğŸ­ Scenarios: $$(find outputs/scenarios -name "*.json" 2>/dev/null | wc -l | tr -d ' ') files"
	@echo "ğŸµ Voice files: $$(find outputs/voices -name "*.mp3" 2>/dev/null | wc -l | tr -d ' ') files"
	@echo "ğŸ“‹ Documents: $$(find outputs/documents -name "*.json" -o -name "*.md" 2>/dev/null | wc -l | tr -d ' ') files"
	@echo ""
	@echo "ğŸ’¾ Total size: $$(du -sh outputs 2>/dev/null | cut -f1 || echo '0B')"

clean-outputs: ## Clean all generated data (keep structure)
	@echo "ğŸ§¹ Cleaning generated data..."
	@find outputs -type f -name "*.json" -delete 2>/dev/null || true
	@find outputs -type f -name "*.mp3" -delete 2>/dev/null || true
	@find outputs -type f -name "*.wav" -delete 2>/dev/null || true
	@find outputs -type f -name "*.csv" -delete 2>/dev/null || true
	@find outputs -type f -name "*.md" ! -name "README.md" -delete 2>/dev/null || true
	@echo "âœ… Generated data cleaned (structure preserved)"

export-json: ## Export all data as JSON
	@echo "ğŸ“¤ Exporting data as JSON..."
	@mkdir -p outputs/exports/json
	@find outputs -name "*.json" -not -path "*/exports/*" -exec cp {} outputs/exports/json/ \; 2>/dev/null || true
	@echo "âœ… JSON export complete: outputs/exports/json/"

export-training: ## Export data in training format
	@echo "ğŸ¤– Exporting training data..."
	@mkdir -p outputs/exports/training
	@echo "Training data export would combine all personas, scenarios, and documents"
	@echo "ğŸ“‹ See outputs/exports/training/ for ML-ready datasets"

backup-data: ## Create timestamped backup of all data
	@echo "ğŸ’¾ Creating data backup..."
	@timestamp=$$(date +%Y%m%d_%H%M%S) && \
	 tar -czf "data_backup_$$timestamp.tar.gz" outputs/ && \
	 echo "âœ… Backup created: data_backup_$$timestamp.tar.gz"

restore-from-archive: ## Restore latest deployment from archive
	@echo "ğŸ“¦ Restoring from latest archive..."
	@latest_archive=$$(ls -t archives/*.tar.gz 2>/dev/null | head -1); \
	if [ -n "$$latest_archive" ]; then \
		echo "ğŸ“‚ Extracting: $$latest_archive"; \
		tar -xzf "$$latest_archive" -C .; \
		echo "âœ… Data restored from archive"; \
	else \
		echo "âŒ No archives found in archives/"; \
	fi

deploy-production: ## Run production data management system
	@echo "ğŸ­ Running production data deployment..."
	@uv run python scripts/data_management_system.py

